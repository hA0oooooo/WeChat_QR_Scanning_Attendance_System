{% extends 'base.html' %}

{% block title %}请假申请 - 微信扫码考勤系统{% endblock %}

{% block content %}
<div class="container">
    <h2 class="mb-4">请假申请</h2>

    <div class="row">
        <!-- 请假申请表单 -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">提交请假申请</h5>
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="leaveType" class="form-label">请假类型</label>
                            <select class="form-select" id="leaveType" name="leave_type" required>
                                <option value="">请选择请假类型</option>
                                <option value="1">事假</option>
                                <option value="2">病假</option>
                                <option value="3">其他</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="startDate" class="form-label">开始日期</label>
                            <input type="date" class="form-control" id="startDate" name="start_date" required>
                        </div>
                        <div class="mb-3">
                            <label for="endDate" class="form-label">结束日期</label>
                            <input type="date" class="form-control" id="endDate" name="end_date" required>
                        </div>
                        <div class="mb-3">
                            <label for="reason" class="form-label">请假原因</label>
                            <textarea class="form-control" id="reason" name="reason" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="attachment" class="form-label">附件（选填）</label>
                            <input type="file" class="form-control" id="attachment" name="attachment">
                            <div class="form-text">支持图片、PDF等格式，最大10MB</div>
                        </div>
                        <button type="submit" class="btn btn-primary">提交申请</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 请假记录 -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">请假记录</h5>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>申请时间</th>
                                    <th>类型</th>
                                    <th>开始日期</th>
                                    <th>结束日期</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for request in leave_requests %}
                                <tr>
                                    <td>{{ request.created_at|date:"Y-m-d H:i" }}</td>
                                    <td>
                                        {% if request.leave_type == 1 %}
                                            事假
                                        {% elif request.leave_type == 2 %}
                                            病假
                                        {% else %}
                                            其他
                                        {% endif %}
                                    </td>
                                    <td>{{ request.start_date }}</td>
                                    <td>{{ request.end_date }}</td>
                                    <td>
                                        {% if request.status == 0 %}
                                            <span class="badge bg-warning">待审批</span>
                                        {% elif request.status == 1 %}
                                            <span class="badge bg-success">已批准</span>
                                        {% else %}
                                            <span class="badge bg-danger">已拒绝</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-info" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#detailModal{{ request.id }}">
                                            详情
                                        </button>
                                    </td>
                                </tr>

                                <!-- 详情模态框 -->
                                <div class="modal fade" id="detailModal{{ request.id }}" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">请假详情</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <p><strong>申请时间：</strong>{{ request.created_at|date:"Y-m-d H:i" }}</p>
                                                <p><strong>请假类型：</strong>
                                                    {% if request.leave_type == 1 %}
                                                        事假
                                                    {% elif request.leave_type == 2 %}
                                                        病假
                                                    {% else %}
                                                        其他
                                                    {% endif %}
                                                </p>
                                                <p><strong>开始日期：</strong>{{ request.start_date }}</p>
                                                <p><strong>结束日期：</strong>{{ request.end_date }}</p>
                                                <p><strong>请假原因：</strong>{{ request.reason }}</p>
                                                {% if request.attachment %}
                                                <p><strong>附件：</strong>
                                                    <a href="{{ request.attachment.url }}" target="_blank">查看附件</a>
                                                </p>
                                                {% endif %}
                                                <p><strong>审批状态：</strong>
                                                    {% if request.status == 0 %}
                                                        <span class="badge bg-warning">待审批</span>
                                                    {% elif request.status == 1 %}
                                                        <span class="badge bg-success">已批准</span>
                                                    {% else %}
                                                        <span class="badge bg-danger">已拒绝</span>
                                                    {% endif %}
                                                </p>
                                                {% if request.approver %}
                                                <p><strong>审批人：</strong>{{ request.approver.username }}</p>
                                                <p><strong>审批时间：</strong>{{ request.approved_at|date:"Y-m-d H:i" }}</p>
                                                <p><strong>审批意见：</strong>{{ request.approval_comment|default:"无" }}</p>
                                                {% endif %}
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center">暂无请假记录</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
// 日期选择验证
document.getElementById('startDate').addEventListener('change', function() {
    const endDate = document.getElementById('endDate');
    endDate.min = this.value;
});

document.getElementById('endDate').addEventListener('change', function() {
    const startDate = document.getElementById('startDate');
    startDate.max = this.value;
});
</script>
{% endblock %}
{% endblock %} 