{% extends 'base.html' %}

{% block title %}考勤统计 - 微信扫码考勤系统{% endblock %}

{% block content %}
<div class="container">
    <!-- 查询和统计部分 -->
    <div class="row mb-4">
        <!-- 查询条件 -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">查询条件</h5>
                    <form method="get" id="searchForm">
                        <div class="mb-3">
                            <label for="course" class="form-label">课程</label>
                            <select class="form-select" id="course" name="course">
                                <option value="">全部课程</option>
                                {% for course in courses %}
                                <option value="{{ course.id }}" {% if selected_course == course.id %}selected{% endif %}>
                                    {{ course.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="dateRange" class="form-label">日期范围</label>
                            <div class="input-group">
                                <input type="date" class="form-control" id="startDate" name="start_date" 
                                       value="{{ start_date|date:'Y-m-d' }}">
                                <span class="input-group-text">至</span>
                                <input type="date" class="form-control" id="endDate" name="end_date" 
                                       value="{{ end_date|date:'Y-m-d' }}">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="status" class="form-label">考勤状态</label>
                            <select class="form-select" id="status" name="status">
                                <option value="">全部状态</option>
                                <option value="1" {% if selected_status == '1' %}selected{% endif %}>正常</option>
                                <option value="2" {% if selected_status == '2' %}selected{% endif %}>迟到</option>
                                <option value="3" {% if selected_status == '3' %}selected{% endif %}>早退</option>
                                <option value="4" {% if selected_status == '4' %}selected{% endif %}>缺勤</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">查询</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="exportToExcel()">
                            导出Excel
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 统计卡片 -->
        <div class="col-md-8">
            <div class="row">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <h6 class="card-title">总考勤次数</h6>
                            <p class="display-6">{{ total_count }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <h6 class="card-title">正常出勤</h6>
                            <p class="display-6">{{ normal_count }}</p>
                            <small>{{ normal_rate }}%</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <h6 class="card-title">迟到/早退</h6>
                            <p class="display-6">{{ late_early_count }}</p>
                            <small>{{ late_early_rate }}%</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <h6 class="card-title">缺勤</h6>
                            <p class="display-6">{{ absent_count }}</p>
                            <small>{{ absent_rate }}%</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 考勤趋势图 -->
            <div class="card mt-3">
                <div class="card-body">
                    <h6 class="card-title">考勤趋势</h6>
                    <canvas id="attendanceTrendChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 考勤记录表格 -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>课程</th>
                            <th>学号</th>
                            <th>姓名</th>
                            <th>签到时间</th>
                            <th>签退时间</th>
                            <th>状态</th>
                            <th>备注</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in records %}
                        <tr>
                            <td>{{ record.date|date:"Y-m-d" }}</td>
                            <td>{{ record.course.name }}</td>
                            <td>{{ record.student.student_id }}</td>
                            <td>{{ record.student.name }}</td>
                            <td>{{ record.check_in_time|time:"H:i:s"|default:"-" }}</td>
                            <td>{{ record.check_out_time|time:"H:i:s"|default:"-" }}</td>
                            <td>
                                {% if record.status == 1 %}
                                <span class="badge bg-success">正常</span>
                                {% elif record.status == 2 %}
                                <span class="badge bg-warning">迟到</span>
                                {% elif record.status == 3 %}
                                <span class="badge bg-warning">早退</span>
                                {% elif record.status == 4 %}
                                <span class="badge bg-danger">缺勤</span>
                                {% else %}
                                <span class="badge bg-secondary">未签到</span>
                                {% endif %}
                            </td>
                            <td>{{ record.remarks|default:"-" }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" 
                                        data-record-id="{{ record.id }}"
                                        onclick="editRecord(this.dataset.recordId)">
                                    编辑
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center">暂无考勤记录</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- 分页 -->
            {% if records.has_other_pages %}
            <nav aria-label="Page navigation" class="mt-3">
                <ul class="pagination justify-content-center">
                    {% if records.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ records.previous_page_number }}">上一页</a>
                    </li>
                    {% endif %}

                    {% for num in records.paginator.page_range %}
                    <li class="page-item {% if records.number == num %}active{% endif %}">
                        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                    </li>
                    {% endfor %}

                    {% if records.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ records.next_page_number }}">下一页</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

<!-- 编辑考勤记录模态框 -->
<div class="modal fade" id="editRecordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑考勤记录</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editRecordForm">
                    <input type="hidden" id="recordId" name="record_id">
                    <div class="mb-3">
                        <label for="editStatus" class="form-label">考勤状态</label>
                        <select class="form-select" id="editStatus" name="status">
                            <option value="1">正常</option>
                            <option value="2">迟到</option>
                            <option value="3">早退</option>
                            <option value="4">缺勤</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editRemarks" class="form-label">备注</label>
                        <textarea class="form-control" id="editRemarks" name="remarks" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveRecord()">保存</button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// 导出Excel功能
function exportToExcel() {
    const form = document.getElementById('searchForm');
    form.action = "{% url 'export_attendance' %}";
    form.submit();
    form.action = "";
}

// 编辑考勤记录
function editRecord(recordId) {
    fetch(`/api/attendance/record/${recordId}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('recordId').value = data.id;
            document.getElementById('editStatus').value = data.status;
            document.getElementById('editRemarks').value = data.remarks;
            new bootstrap.Modal(document.getElementById('editRecordModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('获取考勤记录失败');
        });
}

// 保存考勤记录
function saveRecord() {
    const formData = new FormData(document.getElementById('editRecordForm'));
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`/api/attendance/record/${formData.get('record_id')}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('保存失败：' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('保存考勤记录失败');
    });
}

// 绘制考勤趋势图
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('attendanceTrendChart').getContext('2d');
    const trendDates = JSON.parse('{{ trend_dates|safe }}');
    const normalRates = JSON.parse('{{ normal_rates|safe }}');
    const lateEarlyRates = JSON.parse('{{ late_early_rates|safe }}');
    const absentRates = JSON.parse('{{ absent_rates|safe }}');

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: trendDates,
            datasets: [
                {
                    label: '正常出勤率',
                    data: normalRates,
                    borderColor: 'rgb(40, 167, 69)',
                    tension: 0.1
                },
                {
                    label: '迟到/早退率',
                    data: lateEarlyRates,
                    borderColor: 'rgb(255, 193, 7)',
                    tension: 0.1
                },
                {
                    label: '缺勤率',
                    data: absentRates,
                    borderColor: 'rgb(220, 53, 69)',
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}
{% endblock %} 